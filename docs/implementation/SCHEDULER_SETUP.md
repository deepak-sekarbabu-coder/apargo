# Payment Events Automated Scheduler Setup

This guide explains how to set up automated monthly generation of payment events using the scheduler API endpoint.\n\n## Overview\n\nThe Payment Events Tracker includes an automated scheduler that can generate monthly payment events (like maintenance fees) automatically on specified days of each month. This eliminates the need for manual generation each month.\n\n## API Endpoint\n\n### Scheduler Endpoint\n- **URL**: `/api/payment-events/scheduler`\n- **Methods**: `POST` (generate), `GET` (status)\n\n### Authentication\nThe scheduler supports two authentication methods:\n1. **Scheduler Token**: Set `SCHEDULER_TOKEN` environment variable and include `x-scheduler-token` header\n2. **Admin Authentication**: Standard admin user authentication\n\n## Setup Instructions\n\n### 1. Environment Variables\n\nAdd to your `.env.local` file:\n`bash\n# Scheduler token for automated payment event generation\nSCHEDULER_TOKEN=your-secure-scheduler-token-here\n`\n\n### 2. Cron Job Setup (Linux/Mac)\n\nCreate a cron job to run the scheduler daily:\n\n`bash\n# Edit crontab\ncrontab -e\n\n# Add daily execution at 9:00 AM\n0 9 * * * curl -X POST https://your-domain.com/api/payment-events/scheduler \\\n  -H \"Content-Type: application/json\" \\\n  -H \"x-scheduler-token: your-secure-scheduler-token-here\" \\\n  -d '{}' \\\n  >> /var/log/payment-scheduler.log 2>&1\n`\n\n### 3. Windows Task Scheduler\n\nFor Windows servers, create a scheduled task:\n\n1. Open Task Scheduler\n2. Create Basic Task\n3. Set trigger to \"Daily\" at desired time\n4. Action: \"Start a program\"\n5. Program: `powershell.exe`\n6. Arguments:\n`powershell\n-Command \"Invoke-RestMethod -Uri 'https://your-domain.com/api/payment-events/scheduler' -Method POST -Headers @{'Content-Type'='application/json'; 'x-scheduler-token'='your-secure-scheduler-token-here'} -Body '{}'\"\n`\n\n### 4. GitHub Actions (CI/CD)\n\nCreate `.github/workflows/payment-scheduler.yml`:\n\n`yaml\nname: Payment Events Scheduler\n\non:\n  schedule:\n    # Run daily at 9:00 AM UTC\n    - cron: '0 9 * * *'\n  workflow_dispatch: # Allow manual trigger\n\njobs:\n  generate-payment-events:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Generate Payment Events\n        run: |\n          curl -X POST ${{ secrets.APP_URL }}/api/payment-events/scheduler \\\n            -H \"Content-Type: application/json\" \\\n            -H \"x-scheduler-token: ${{ secrets.SCHEDULER_TOKEN }}\" \\\n            -d '{}'\n`\n\n### 5. Netlify Functions (Serverless)\n\nCreate `netlify/functions/payment-scheduler.js`:\n\n``javascript\nexports.handler = async (event, context) => {\n  try {\n    const response = await fetch(`${process.env.URL}/api/payment-events/scheduler`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'x-scheduler-token': process.env.SCHEDULER_TOKEN\n      },\n      body: JSON.stringify({})\n    });\n    \n    const result = await response.json();\n    \n    return {\n      statusCode: 200,\n      body: JSON.stringify(result)\n    };\n  } catch (error) {\n    return {\n      statusCode: 500,\n      body: JSON.stringify({ error: error.message })\n    };\n  }\n};\n``\n\nThen set up a Netlify scheduled function or use a third-party cron service.\n\n## Configuration\n\n### Category Setup\n\nFor automatic generation, categories must be configured with:\n- `isPaymentEvent: true`\n- `autoGenerate: true`\n- `monthlyAmount: > 0`\n- `dayOfMonth: 1-28` (day of month to generate)\n\n### Example Category Configuration\n\n`javascript\n{\n  \"id\": \"maintenance\",\n  \"name\": \"Monthly Maintenance Fee\",\n  \"icon\": \"üè†\",\n  \"isPaymentEvent\": true,\n  \"monthlyAmount\": 2500,\n  \"dayOfMonth\": 1,\n  \"autoGenerate\": true\n}\n`\n\n## API Usage\n\n### Generate Payment Events\n\n`bash\n# Manual generation for current month\ncurl -X POST https://your-domain.com/api/payment-events/scheduler \\\n  -H \"Content-Type: application/json\" \\\n  -H \"x-scheduler-token: your-token\" \\\n  -d '{}'\n\n# Generate for specific month\ncurl -X POST https://your-domain.com/api/payment-events/scheduler \\\n  -H \"Content-Type: application/json\" \\\n  -H \"x-scheduler-token: your-token\" \\\n  -d '{\"monthYear\": \"2024-01\"}'\n\n# Force generation (ignore existing events)\ncurl -X POST https://your-domain.com/api/payment-events/scheduler \\\n  -H \"Content-Type: application/json\" \\\n  -H \"x-scheduler-token: your-token\" \\\n  -d '{\"force\": true}'\n`\n\n### Check Scheduler Status\n\n`bash\ncurl -X GET https://your-domain.com/api/payment-events/scheduler \\\n  -H \"Authorization: Bearer your-admin-token\"\n`\n\n## Response Examples\n\n### Successful Generation\n\n`json\n{\n  \"success\": true,\n  \"message\": \"Automated generation completed: 21 payment events created for 2024-01\",\n  \"monthYear\": \"2024-01\",\n  \"eventsCreated\": 21,\n  \"processedCategories\": 3,\n  \"results\": [\n    {\n      \"categoryId\": \"maintenance\",\n      \"categoryName\": \"Monthly Maintenance Fee\",\n      \"eventsCreated\": 7\n    },\n    {\n      \"categoryId\": \"security\",\n      \"categoryName\": \"Security Fee\",\n      \"eventsCreated\": 7\n    },\n    {\n      \"categoryId\": \"utilities\",\n      \"categoryName\": \"Common Area Utilities\",\n      \"eventsCreated\": 7\n    }\n  ],\n  \"scheduledOn\": \"2024-01-01T09:00:00.000Z\",\n  \"triggerDay\": 1\n}\n`\n\n### Scheduler Status\n\n`json\n{\n  \"success\": true,\n  \"currentDate\": \"2024-01-15T09:00:00.000Z\",\n  \"currentDay\": 15,\n  \"currentMonth\": \"2024-01\",\n  \"totalConfiguredCategories\": 3,\n  \"schedulerStatus\": \"active\",\n  \"scheduledCategories\": [\n    {\n      \"categoryId\": \"maintenance\",\n      \"categoryName\": \"Monthly Maintenance Fee\",\n      \"monthlyAmount\": 2500,\n      \"dayOfMonth\": 1,\n      \"nextGenerationDate\": \"2024-02-01\",\n      \"isScheduledToday\": false\n    }\n  ],\n  \"upcomingGenerations\": [\n    {\n      \"categoryId\": \"maintenance\",\n      \"categoryName\": \"Monthly Maintenance Fee\",\n      \"nextGenerationDate\": \"2024-02-01\"\n    }\n  ]\n}\n`\n\n## Monitoring and Logging\n\n### Log Files\n\nThe scheduler writes logs to help with monitoring:\n- Console logs for successful/failed generation\n- Detailed error messages for troubleshooting\n- Timestamp information for audit trails\n\n### Monitoring Checklist\n\n- [ ] Scheduler runs daily without errors\n- [ ] Payment events are generated on configured days\n- [ ] No duplicate events are created\n- [ ] All apartments receive payment events\n- [ ] Balance sheets are updated correctly\n- [ ] Admin notifications are working (if implemented)\n\n## Troubleshooting\n\n### Common Issues\n\n1. **No events generated**\n - Check category configuration (`isPaymentEvent`, `autoGenerate`, `monthlyAmount`)\n - Verify it's the correct day of month (`dayOfMonth`)\n - Check authentication (scheduler token or admin auth)\n\n2. **Duplicate events**\n - The scheduler prevents duplicates by default\n - Use `force: true` only when necessary\n - Check for manual generation on the same day\n\n3. **Authentication failures**\n - Verify `SCHEDULER_TOKEN` environment variable\n - Check `x-scheduler-token` header in requests\n - Ensure admin users have proper permissions\n\n4. **Missing apartments**\n - Verify all apartments have at least one member\n - Check apartment data in Firestore\n - Review user-apartment associations\n\n### Debug Mode\n\nEnable debug logging by checking the browser console or server logs when testing the scheduler endpoint manually through the admin interface.\n\n## Security Considerations\n\n- Use a strong, unique scheduler token\n- Rotate the scheduler token regularly\n- Limit scheduler endpoint access to trusted systems\n- Monitor scheduler logs for unauthorized access attempts\n- Use HTTPS for all scheduler API calls\n\n## Integration with Admin Interface\n\nThe admin interface includes:\n- Manual generation button in Categories tab\n- Payment events overview with current month status\n- Scheduler status in the Payment Events tab\n- Historical view of generated events\n\nAdmins can use these features to monitor and manually trigger payment event generation when needed.
